<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <link rel="icon" type="image/png" href="../assets/icons/favicon.png" />
    <title>Book Appointment - SwasthyaSetu</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:wght@600;700&display=swap"
        rel="stylesheet" />

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />

    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#86efac",
                        secondary: "#113841",
                        "secondary-light": "#1d525e",
                        "background-dark": "#0d2b32",
                        "background-light": "#fffefc", // Light cream background
                        "health-orange": "#f78e69",
                    },
                    fontFamily: {
                        display: ["Playfair Display", "serif"],
                        sans: ["DM Sans", "sans-serif"],
                    },
                },
            },
        };
    </script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components/chatbot.css">
</head>

<body
    class="bg-background-light dark:bg-background-dark font-sans antialiased text-gray-800 dark:text-gray-100 min-h-screen relative">
    <!-- Global Dot Pattern Overlay -->
    <div class="fixed inset-0 w-full h-full dot-pattern pointer-events-none z-0"></div>

    <!-- Navigation -->
    <nav
        class="w-full bg-secondary text-white py-4 px-6 md:px-12 flex justify-between items-center border-b border-white/10">
        <a href="../index.html" class="flex items-center gap-2">
            <img src="../assets/images/logo.png" alt="SwasthyaSetu Logo" class="h-8 w-auto">
        </a>
        <div class="hidden md:flex items-center gap-8 text-sm font-medium text-gray-300">
            <a class="hover:text-primary transition-colors" href="dashboard.html">Dashboard</a>
            <a class="hover:text-primary transition-colors" href="hospitals.html">Hospitals</a>
            <a class="text-primary font-semibold" href="appointments.html">Appointments</a>
            <a class="hover:text-primary transition-colors" href="profile.html">Profile</a>
        </div>
        <div class="flex items-center gap-4">
            <button id="logout-btn"
                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors text-sm font-semibold">
                Logout
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-6 py-8">
        <!-- Header -->
        <div class="mb-8">
            <a href="appointments.html"
                class="inline-flex items-center gap-1 text-gray-500 hover:text-secondary dark:hover:text-primary mb-4 transition-colors">
                <span class="material-icons-outlined text-sm">arrow_back</span>
                Back to Appointments
            </a>
            <h1 class="font-display text-4xl font-bold text-secondary dark:text-white mb-2">Book New Appointment</h1>
            <p class="text-gray-600 dark:text-gray-400">Schedule a consultation with a specialist</p>
        </div>

        <div class="grid md:grid-cols-3 gap-8">
            <!-- Left Column: Patient Details (Pre-filled) -->
            <div class="md:col-span-1 space-y-6">
                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-sm border border-gray-200 dark:border-gray-700">
                    <h2 class="font-bold text-lg text-secondary dark:text-white mb-4 flex items-center gap-2">
                        <span class="material-icons-outlined text-primary">person</span>
                        Patient Details
                    </h2>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Full
                                Name</label>
                            <input type="text" id="patient-name" readonly
                                class="w-full bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-200 cursor-not-allowed text-sm font-medium">
                        </div>

                        <div>
                            <label
                                class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Age</label>
                            <input type="text" id="patient-age" readonly
                                class="w-full bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-200 cursor-not-allowed text-sm font-medium">
                        </div>

                        <div>
                            <label
                                class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Gender</label>
                            <input type="text" id="patient-gender" readonly
                                class="w-full bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-200 cursor-not-allowed text-sm font-medium">
                        </div>

                        <div>
                            <label
                                class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Mobile
                                Number</label>
                            <input type="text" id="patient-mobile" readonly
                                class="w-full bg-gray-50 dark:bg-gray-700 border-gray-200 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-200 cursor-not-allowed text-sm font-medium">
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
                        <p class="text-xs text-gray-400 italic">
                            Details are fetched from your profile. To edit, go to <a href="profile.html"
                                class="text-secondary dark:text-primary hover:underline">Profile Settings</a>.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Booking Form -->
            <div class="md:col-span-2">
                <form id="booking-form"
                    class="bg-white dark:bg-gray-800 rounded-2xl p-6 md:p-8 shadow-sm border border-gray-200 dark:border-gray-700">
                    <h2 class="font-bold text-lg text-secondary dark:text-white mb-6 flex items-center gap-2">
                        <span class="material-icons-outlined text-primary">event_note</span>
                        Appointment Details
                    </h2>

                    <div class="space-y-6">
                        <!-- Hospital (First) -->
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Hospital</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="material-icons-outlined text-gray-400">local_hospital</span>
                                </span>
                                <!-- Trigger for Modal -->
                                <button type="button" id="hospital-trigger"
                                    class="block w-full pl-10 pr-10 py-3 text-left border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-500 dark:text-gray-400 focus:ring-secondary focus:border-secondary transition-shadow hover:bg-gray-50 dark:hover:bg-gray-800">
                                    Select Nearby Hospital
                                </button>
                                <!-- Hidden input to store value -->
                                <input type="hidden" id="hospital-input" required name="hospital">
                                <input type="hidden" id="hospital-address-input" name="hospitalAddress">

                                <div id="location-status"
                                    class="text-xs text-gray-500 mt-1 ml-1 flex items-center gap-1 hidden">
                                    <span class="material-icons-outlined text-[10px] animate-pulse">my_location</span>
                                    <span>Locating...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Department -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Specialty /
                                Department</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="material-icons-outlined text-gray-400">category</span>
                                </span>
                                <input type="text" id="department-trigger" readonly placeholder="Select a Department"
                                    required
                                    class="block w-full pl-10 pr-10 py-3 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 focus:ring-secondary focus:border-secondary transition-shadow cursor-pointer">
                                <span class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="material-icons-outlined text-gray-400">arrow_drop_down</span>
                                </span>
                                <input type="hidden" id="department-input" name="specialty">
                            </div>
                        </div>

                        <!-- Doctor (New) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Choose a
                                Doctor</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="material-icons-outlined text-gray-400">person_search</span>
                                </span>
                                <select required id="doctor-select" disabled
                                    class="block w-full pl-10 pr-10 py-3 border-gray-300 dark:border-gray-600 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 cursor-not-allowed focus:ring-secondary focus:border-secondary transition-shadow">
                                    <option value="" disabled selected>Select Department First</option>
                                </select>
                            </div>
                        </div>

                        <!-- Date and Time -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Preferred
                                    Date</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="material-icons-outlined text-gray-400">calendar_today</span>
                                    </span>
                                    <input type="date" required
                                        class="block w-full pl-10 pr-3 py-3 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-secondary focus:border-secondary transition-shadow">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Preferred
                                    Time</label>
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="material-icons-outlined text-gray-400">schedule</span>
                                    </span>
                                    <select required id="appointment-time"
                                        class="block w-full pl-10 pr-10 py-3 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-secondary focus:border-secondary transition-shadow">
                                        <option value="" disabled selected>Select Time Slot</option>
                                        <option value="09:00 AM">09:00 AM - 10:00 AM</option>
                                        <option value="10:00 AM">10:00 AM - 11:00 AM</option>
                                        <option value="11:00 AM">11:00 AM - 12:00 PM</option>
                                        <option value="02:00 PM">02:00 PM - 03:00 PM</option>
                                        <option value="03:00 PM">03:00 PM - 04:00 PM</option>
                                        <option value="04:00 PM">04:00 PM - 05:00 PM</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Reason -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Reason for
                                Visit (Optional)</label>
                            <textarea rows="3" placeholder="Briefly describe your symptoms or reason for visit..."
                                class="block w-full p-3 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-secondary focus:border-secondary transition-shadow"></textarea>
                        </div>
                    </div>

                    <div class="mt-8 flex gap-4">
                        <button type="button" onclick="window.location.href='appointments.html'"
                            class="flex-1 px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-bold rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            Cancel
                        </button>
                        <button type="submit"
                            class="flex-1 px-6 py-3 bg-secondary text-white font-bold rounded-xl hover:bg-secondary-light transition-all transform hover:scale-[1.02] shadow-lg flex items-center justify-center gap-2">
                            <span>Confirm Booking</span>
                            <span class="material-icons-outlined">check_circle</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Success Modal -->
    <div id="booking-success-modal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div
            class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-4 text-center transform scale-100 transition-transform">
            <div
                class="w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="material-icons-outlined text-green-600 text-3xl">done</span>
            </div>
            <h3 class="font-display text-2xl font-bold text-gray-900 dark:text-white mb-2">Booking Confirmed!</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">Your appointment has been successfully scheduled.
            </p>
            <button onclick="window.location.href='appointments.html'"
                class="w-full bg-secondary text-white font-bold py-3 px-6 rounded-xl hover:bg-secondary-light transition-colors">
                View My Appointments
            </button>
        </div>
    </div>

    <!-- Hospital Selection Modal -->
    <div id="hospital-modal"
        class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div
            class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col overflow-hidden transform transition-all scale-100">
            <!-- Modal Header -->
            <div
                class="p-5 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50">
                <div>
                    <h3 class="font-display text-xl font-bold text-secondary dark:text-white">Select Hospital</h3>
                    <p id="modal-location-status" class="text-xs text-gray-500 flex items-center gap-1 mt-1">
                        <span class="material-icons-outlined text-[12px] animate-spin">refresh</span>
                        Detecting your location...
                    </p>
                </div>
                <button type="button" id="close-modal-btn"
                    class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <span class="material-icons-outlined text-gray-500">close</span>
                </button>
            </div>

            <!-- Hospital List -->
            <div id="hospital-list-container" class="overflow-y-auto p-4 space-y-3 flex-1">
                <!-- Loading State -->
                <div class="flex flex-col items-center justify-center py-10 text-gray-400">
                    <span class="material-icons-outlined text-4xl mb-2 animate-bounce">place</span>
                    <p>Searching for nearby hospitals...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Department Selection Modal -->
    <div id="department-modal"
        class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div
            class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col overflow-hidden transform transition-all scale-100">
            <div
                class="p-5 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50">
                <h3 class="font-display text-xl font-bold text-secondary dark:text-white">Select Department</h3>
                <button type="button" id="close-department-modal-btn"
                    class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition-colors">
                    <span class="material-icons-outlined text-gray-500">close</span>
                </button>
            </div>
            <div class="p-4 grid grid-cols-2 gap-4 overflow-y-auto">
                <!-- Department Items -->
                <div class="department-item cursor-pointer p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 flex flex-col items-center gap-2 text-center transition-all"
                    data-value="General Medicine">
                    <div
                        class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/40 flex items-center justify-center text-blue-600 dark:text-blue-400">
                        <span class="material-icons-outlined">medical_services</span>
                    </div>
                    <span class="font-bold text-gray-800 dark:text-gray-200">General Medicine</span>
                </div>
                <div class="department-item cursor-pointer p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 flex flex-col items-center gap-2 text-center transition-all"
                    data-value="Cardiology">
                    <div
                        class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/40 flex items-center justify-center text-red-600 dark:text-red-400">
                        <span class="material-icons-outlined">favorite</span>
                    </div>
                    <span class="font-bold text-gray-800 dark:text-gray-200">Cardiology</span>
                </div>
                <div class="department-item cursor-pointer p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 flex flex-col items-center gap-2 text-center transition-all"
                    data-value="Pediatrics">
                    <div
                        class="w-12 h-12 rounded-full bg-yellow-100 dark:bg-yellow-900/40 flex items-center justify-center text-yellow-600 dark:text-yellow-400">
                        <span class="material-icons-outlined">child_care</span>
                    </div>
                    <span class="font-bold text-gray-800 dark:text-gray-200">Pediatrics</span>
                </div>
                <div class="department-item cursor-pointer p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 flex flex-col items-center gap-2 text-center transition-all"
                    data-value="Orthopedics">
                    <div
                        class="w-12 h-12 rounded-full bg-purple-100 dark:bg-purple-900/40 flex items-center justify-center text-purple-600 dark:text-purple-400">
                        <span class="material-icons-outlined">accessibility_new</span>
                    </div>
                    <span class="font-bold text-gray-800 dark:text-gray-200">Orthopedics</span>
                </div>
                <div class="department-item cursor-pointer p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 flex flex-col items-center gap-2 text-center transition-all"
                    data-value="Dermatology">
                    <div
                        class="w-12 h-12 rounded-full bg-pink-100 dark:bg-pink-900/40 flex items-center justify-center text-pink-600 dark:text-pink-400">
                        <span class="material-icons-outlined">face</span>
                    </div>
                    <span class="font-bold text-gray-800 dark:text-gray-200">Dermatology</span>
                </div>
                <div class="department-item cursor-pointer p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 flex flex-col items-center gap-2 text-center transition-all"
                    data-value="Gynecology">
                    <div
                        class="w-12 h-12 rounded-full bg-indigo-100 dark:bg-indigo-900/40 flex items-center justify-center text-indigo-600 dark:text-indigo-400">
                        <span class="material-icons-outlined">pregnant_woman</span>
                    </div>
                    <span class="font-bold text-gray-800 dark:text-gray-200">Gynecology</span>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../js/config/constants.js"></script>
    <script src="../js/config/app-config.js"></script>
    <script src="../js/utils/app-utils.js"></script>
    <script src="../js/services/api.js"></script>
    <script src="../js/services/auth.js"></script>
    <script src="../js/components/navigation.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize auth
            AuthService.init();

            // Check auth
            if (!AuthService.isAuthenticated()) {
                window.location.href = '../index.html';
                return;
            }

            const user = AuthService.getCurrentUser();

            // Pre-fill fields
            if (user) {
                document.getElementById('patient-name').value = user.name || 'N/A';
                document.getElementById('patient-age').value = user.age || 'N/A';
                document.getElementById('patient-gender').value = user.gender || 'N/A';
                document.getElementById('patient-mobile').value = user.mobile || user.identifier || 'N/A';
            }

            // Logout button
            document.getElementById('logout-btn').addEventListener('click', async () => {
                await AuthService.logout();
                window.location.href = '../index.html';
            });

            // --- Modal & Hospital Logic ---
            const hospitalModal = document.getElementById('hospital-modal');
            const hospitalTrigger = document.getElementById('hospital-trigger');
            const hospitalInput = document.getElementById('hospital-input');
            const hospitalAddressInput = document.getElementById('hospital-address-input'); // Ensure this matches HTML ID
            const closeModalBtn = document.getElementById('close-modal-btn');
            const hospitalListContainer = document.getElementById('hospital-list-container');
            const modalLocationStatus = document.getElementById('modal-location-status');

            // Check for Autofill Params from Hospitals Page
            const urlParams = new URLSearchParams(window.location.search);
            const prefillName = urlParams.get('hospital');
            const prefillAddress = urlParams.get('address');

            if (prefillName) {
                // Visual Update
                hospitalTrigger.innerHTML = `
                    <div class="flex flex-col items-start leading-tight">
                        <span class="font-bold text-gray-900 dark:text-white">${prefillName}</span>
                        ${prefillAddress ? `<span class="text-xs text-gray-500">${prefillAddress}</span>` : ''}
                    </div>
                `;
                hospitalTrigger.classList.add('border-green-500', 'bg-green-50', 'dark:bg-green-900/10');

                // Value Update
                hospitalInput.value = prefillName;
                if (hospitalAddressInput) hospitalAddressInput.value = prefillAddress || '';
            }

            // Open Modal
            hospitalTrigger.addEventListener('click', () => {
                hospitalModal.classList.remove('hidden');
                // Auto-load hospitals if not already loaded or to refresh location
                loadHospitals();
            });

            // Close Modal
            closeModalBtn.addEventListener('click', () => {
                hospitalModal.classList.add('hidden');
            });

            // Load Hospitals with Location
            function loadHospitals() {
                // Success callback
                const onLocationSuccess = async (position) => {
                    const coords = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };

                    modalLocationStatus.innerHTML = `
                        <span class="material-icons-outlined text-[12px] text-green-500">check_circle</span>
                        <span class="text-green-600">Location detected. Showing nearby hospitals.</span>
                    `;

                    fetchAndPopulateHospitals(coords);
                };

                // Error callback (denied or failed)
                const onLocationError = (error) => {
                    console.warn("Location access denied or failed:", error);
                    modalLocationStatus.innerHTML = `
                        <span class="material-icons-outlined text-[12px] text-orange-500">location_disabled</span>
                        <span class="text-orange-600">Location access denied. Showing major hospitals.</span>
                    `;
                    fetchAndPopulateHospitals(null);
                };

                // Request location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError);
                } else {
                    onLocationError(null);
                }
            }

            async function fetchAndPopulateHospitals(location) {
                try {
                    // 1. Try Local Backend First
                    const response = await APIService.getHospitals(location);

                    if (response.success && response.data.length > 0) {
                        populateHospitalList(response.data);
                        return;
                    }

                    // 2. If Backend Empty, Try Overpass API (OpenStreetMap)
                    if (location) {
                        console.log("Local DB empty, trying Overpass API...");
                        modalLocationStatus.innerHTML = `
                            <span class="material-icons-outlined text-[12px] text-blue-500">public</span>
                            <span class="text-blue-600">Searching global hospital database...</span>
                        `;

                        const overpassHospitals = await fetchHospitalsFromOverpassAPI(location.latitude, location.longitude);

                        if (overpassHospitals.length > 0) {
                            populateHospitalList(overpassHospitals);
                            return;
                        }
                    }

                    // 3. Absolute Fallback to All DB Hospitals (Recursive check to avoid infinite loop)
                    if (location) { // Only fallback if we haven't already tried "null" location
                        console.log("Overpass API failed/empty. Falling back to all DB hospitals.");
                        modalLocationStatus.innerHTML = `
                            <span class="material-icons-outlined text-[12px] text-orange-500">info</span>
                            <span class="text-orange-600">No hospitals nearby. Showing all available hospitals.</span>
                        `;
                        await fetchAndPopulateHospitals(null);
                    } else {
                        hospitalListContainer.innerHTML = '<div class="text-center text-gray-500 py-4">No hospitals found in the database.</div>';
                    }

                } catch (error) {
                    console.error('Error fetching hospitals:', error);
                    hospitalListContainer.innerHTML = '<div class="text-center text-red-500 py-4">Error loading hospitals. Please try again.</div>';
                }
            }

            async function fetchHospitalsFromOverpassAPI(lat, lng) {
                try {
                    const radius = 25000; // Increased to 25km to find more results in rural areas
                    // Query for hospitals, clinics, and doctors
                    const query = `
                        [out:json][timeout:25];
                        (
                          node["amenity"="hospital"](around:${radius},${lat},${lng});
                          way["amenity"="hospital"](around:${radius},${lat},${lng});
                          relation["amenity"="hospital"](around:${radius},${lat},${lng});
                          node["amenity"="clinic"](around:${radius},${lat},${lng});
                          way["amenity"="clinic"](around:${radius},${lat},${lng});
                        );
                        out center;
                    `;
                    const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

                    const response = await fetch(url);
                    const data = await response.json();

                    return data.elements.map(element => {
                        const tags = element.tags || {};
                        const name = tags.name || tags['name:en'] || "Medical Center";

                        // Better address construction
                        let addressParts = [];
                        if (tags['addr:street']) addressParts.push(tags['addr:street']);
                        if (tags['addr:suburb']) addressParts.push(tags['addr:suburb']);
                        if (tags['addr:district']) addressParts.push(tags['addr:district']);
                        if (tags['addr:city']) addressParts.push(tags['addr:city']);

                        let address = "Address details not available";
                        if (addressParts.length > 0) {
                            address = addressParts.join(', ');
                        } else if (tags['addr:full']) {
                            address = tags['addr:full'];
                        }

                        // Determine latitude/longitude (center for ways/relations)
                        const elLat = element.lat || (element.center && element.center.lat);
                        const elLon = element.lon || (element.center && element.center.lon);

                        // Fallback logic for coordinates if missing (shouldn't happen with 'out center')
                        if (!elLat || !elLon) return null;

                        return {
                            _id: element.id,
                            name: name,
                            address: address,
                            distance: calculateDistance(lat, lng, elLat, elLon).toFixed(1),
                            rating: (3.5 + Math.random() * 1.5).toFixed(1),
                            type: tags.healthcare || (tags.amenity === 'clinic' ? 'Clinic' : 'Hospital'),
                            isExternal: true
                        };
                    })
                        .filter(item => item !== null) // Remove failed items
                        .sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance)) // Sort by distance
                        .slice(0, 50); // Limit results
                } catch (err) {
                    console.warn("Overpass API Error:", err);
                    return [];
                }
            }

            // Haversine Distance Helper
            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            function populateHospitalList(hospitals) {
                hospitalListContainer.innerHTML = '';
                hospitals.forEach(hospital => {
                    const item = document.createElement('div');
                    item.className = 'p-4 border border-gray-100 dark:border-gray-700 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer transition-colors group';

                    const distanceBadge = hospital.distance
                        ? `<span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-bold ml-auto flex-shrink-0">${hospital.distance} km</span>`
                        : '';

                    const sourceBadge = hospital.isExternal
                        ? `<span class="bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded-full font-bold ml-2">OSM</span>`
                        : '';

                    item.innerHTML = `
                        <div class="flex items-start gap-3">
                            <div class="bg-blue-100 dark:bg-blue-900/30 p-2 rounded-lg text-blue-600">
                                <span class="material-icons-outlined">local_hospital</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <h4 class="font-bold text-secondary dark:text-white group-hover:text-primary transition-colors flex items-center">
                                        ${hospital.name} ${sourceBadge}
                                    </h4>
                                    ${distanceBadge}
                                </div>
                                <p class="text-xs text-gray-500 mt-1">${hospital.address || hospital.city || 'Address N/A'}</p>
                                <div class="flex gap-2 mt-2 text-xs text-gray-400">
                                    <span class="flex items-center gap-1"><span class="material-icons-outlined text-[10px]">star</span> ${hospital.rating || '4.5'}</span>
                                    <span class="flex items-center gap-1"><span class="material-icons-outlined text-[10px]">medical_services</span> ${hospital.type || 'Hospital'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    // Handle Selection
                    item.addEventListener('click', () => {
                        selectHospital(hospital);
                    });

                    hospitalListContainer.appendChild(item);
                });
            }

            function selectHospital(hospital) {
                // Update trigger button
                hospitalTrigger.innerHTML = `
                    <div class="flex items-center justify-between pointer-events-none">
                        <span class="text-secondary dark:text-white font-semibold">${hospital.name}</span>
                        <span class="material-icons-outlined text-green-500">check_circle</span>
                    </div>
                `;
                hospitalTrigger.classList.add('border-green-500', 'bg-green-50');

                // Set hidden input value
                hospitalInput.value = hospital.name;
                document.getElementById('hospital-address-input').value = hospital.address || '';

                // Close modal
                hospitalModal.classList.add('hidden');

                // Trigger doctor update if department is already selected
                if (document.getElementById('department-input').value) {
                    loadDoctors();
                }
            }



            // --- Doctor Logic ---
            const departmentInput = document.getElementById('department-input');
            const departmentTrigger = document.getElementById('department-trigger');
            const departmentModal = document.getElementById('department-modal');
            const closeDepartmentModalBtn = document.getElementById('close-department-modal-btn');
            const doctorSelect = document.getElementById('doctor-select');

            // Open Department Modal
            departmentTrigger.addEventListener('click', () => {
                departmentModal.classList.remove('hidden');
            });

            // Close Department Modal
            closeDepartmentModalBtn.addEventListener('click', () => {
                departmentModal.classList.add('hidden');
            });

            // Handle Department Selection
            document.querySelectorAll('.department-item').forEach(item => {
                item.addEventListener('click', () => {
                    const value = item.dataset.value;
                    const name = item.querySelector('span.font-bold').textContent;

                    // Update Inputs
                    departmentInput.value = value;
                    departmentTrigger.value = name;

                    // Visual Feedback
                    document.querySelectorAll('.department-item').forEach(el => el.classList.remove('bg-blue-50', 'border-blue-500'));
                    item.classList.add('bg-blue-50', 'border-blue-500');

                    // Close Modal
                    departmentModal.classList.add('hidden');

                    // Load Doctors
                    loadDoctors();
                });
            });

            function loadDoctors() {
                const department = departmentInput.value;
                const hospital = hospitalInput.value; // Optional dependence

                if (!department) return;

                // Enable dropdown
                doctorSelect.disabled = false;
                doctorSelect.className = doctorSelect.className.replace('bg-gray-100 cursor-not-allowed', 'bg-white cursor-pointer');

                // Generate Mock Doctors based on department
                // In a real app, this would be an API call
                const doctors = generateMockDoctors(department);

                doctorSelect.innerHTML = '<option value="" disabled selected>Select a Doctor</option>';
                doctors.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.name;
                    option.textContent = `${doc.name} (${doc.exp} yrs exp)`;
                    doctorSelect.appendChild(option);
                });
            }

            function generateMockDoctors(dept) {
                const names = ['Sharma', 'Verma', 'Patel', 'Gupta', 'Singh', 'Rao', 'Nair', 'Iyer'];
                const doctors = [];
                for (let i = 0; i < 3; i++) {
                    const name = `Dr. ${names[Math.floor(Math.random() * names.length)]}`;
                    doctors.push({
                        name: name,
                        exp: 5 + Math.floor(Math.random() * 20)
                    });
                }
                return doctors;
            }

            // Handle form submission
            document.getElementById('booking-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                // Validate Hospital
                if (!hospitalInput.value) {
                    Helpers.showToast('Please select a hospital first', 'error');
                    hospitalTrigger.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    hospitalTrigger.classList.add('animate-pulse', 'border-red-500');
                    setTimeout(() => hospitalTrigger.classList.remove('animate-pulse', 'border-red-500'), 2000);
                    return;
                }

                // Show loading state
                const btn = e.submitter;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="material-icons-outlined animate-spin">refresh</span> Processing...';
                btn.disabled = true;

                try {
                    // Collect form data
                    const formData = new FormData(e.target);

                    // Get hospital ID
                    const hospitalId = hospitalInput.dataset.id || '507f1f77bcf86cd799439011'; // Use selected ID or fallback

                    const appointmentData = {
                        hospitalId: hospitalId,
                        hospital: hospitalInput.value,
                        hospitalAddress: document.getElementById('hospital-address-input').value,
                        doctor: doctorSelect.value,
                        specialty: departmentInput.value,
                        date: formData.get('date') || e.target.querySelector('input[type="date"]').value,
                        time: document.getElementById('appointment-time').value,
                        type: 'In-person',
                        reason: e.target.querySelector('textarea').value || 'General consultation'
                    };

                    // Call real backend API
                    const response = await APIService.createAppointment(appointmentData);

                    if (response.success) {
                        // Show success modal
                        setTimeout(() => {
                            document.getElementById('booking-success-modal').classList.remove('hidden');
                        }, 500);
                    } else {
                        throw new Error(response.message || 'Failed to create appointment');
                    }
                } catch (error) {
                    console.error('Error creating appointment:', error);
                    Helpers.showToast(error.message || 'Failed to book appointment. Please try again.', 'error');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        });
    </script>

    <!-- Chatbot Scripts -->
    <script src="../js/config/gemini-config.js"></script>
    <script src="../js/services/chatbot-context.js"></script>
    <script src="../js/components/chatbot.js"></script>
    <script>
        // Initialize chatbot after all scripts load
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (typeof Chatbot !== 'undefined') {
                    window.chatbotInstance = new Chatbot();
                    console.log('Chatbot initialized successfully');
                } else {
                    console.error('Chatbot class not found');
                }
            }, 500);
        });
    </script>
</body>

</html>