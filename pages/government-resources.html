<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <link rel="icon" type="image/png" href="../assets/icons/favicon.png" />
    <title>Resource Allocation - Government Portal</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:wght@600;700&display=swap"
        rel="stylesheet" />

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#86efac",
                        secondary: "#113841",
                        "secondary-light": "#1d525e",
                        "background-dark": "#0d2b32",
                        "gov-gold": "#ffd700",
                    },
                    fontFamily: {
                        display: ["Playfair Display", "serif"],
                        sans: ["DM Sans", "sans-serif"],
                    },
                },
            },
        };
    </script>

    <style>
        .nav-link {
            transition: all 0.2s;
            position: relative;
        }

        .nav-link:hover {
            color: #86efac;
        }

        .nav-link.active {
            color: #86efac;
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: #86efac;
        }

        .hero-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2386efac' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4v-4H4v4H0v2h4v4h2v-4h4v-2H6zM36 4v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Leaflet Popup Customization */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-background-dark font-sans antialiased text-gray-900 dark:text-gray-100">

    <!-- Top Navigation -->
    <nav class="bg-secondary dark:bg-secondary text-white border-b border-white/10 sticky top-0 z-50">
        <!-- Top Bar -->
        <div class="px-8 py-4 flex items-center justify-between border-b border-white/10">
            <a href="../index.html" class="flex items-center gap-3">
                <img src="../assets/images/logo.png" alt="SwasthyaSetu Logo" class="h-8 w-auto">
                <div class="flex flex-col">
                    <span class="text-xs font-bold text-gov-gold tracking-widest uppercase">MoHFW Interop Portal</span>
                    <span class="text-xs text-primary font-bold">GOVERNMENT</span>
                </div>
            </a>

            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3 ml-4 pl-4 border-l border-white/20">
                    <img src="https://ui-avatars.com/api/?name=Gov+Admin&background=ffd700&color=113841" alt="User"
                        class="w-8 h-8 rounded-full border border-gov-gold">
                    <div>
                        <p class="text-sm font-semibold" id="admin-name">Ministry Admin</p>
                        <p class="text-xs text-gov-gold" id="admin-dept">National Health Authority</p>
                    </div>
                </div>
                <button id="logout-btn"
                    class="ml-4 px-4 py-2 bg-red-500/80 hover:bg-red-600 text-white rounded-lg text-sm font-semibold transition-colors">
                    Logout
                </button>
            </div>
        </div>

        <!-- Navigation Links -->
        <div class="px-8 py-0 flex items-center gap-8 overflow-x-auto">
            <a href="government-dashboard.html"
                class="nav-link flex items-center gap-2 px-4 py-4 text-sm font-medium text-gray-300">
                <span class="material-icons-outlined text-lg">insights</span>
                National Dashboard
            </a>
            <a href="government-hospitals.html"
                class="nav-link flex items-center gap-2 px-4 py-4 text-sm font-medium text-gray-300">
                <span class="material-icons-outlined text-lg">domain</span>
                Hospital Connectivity
            </a>
            <a href="government-resources.html"
                class="nav-link active flex items-center gap-2 px-4 py-4 text-sm font-medium">
                <span class="material-icons-outlined text-lg">inventory_2</span>
                Resource Allocation
            </a>
            <a href="government-outbreak.html"
                class="nav-link flex items-center gap-2 px-4 py-4 text-sm font-medium text-gray-300">
                <span class="material-icons-outlined text-lg">coronavirus</span>
                Outbreak Predictions
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="p-8 hero-pattern min-h-screen">

        <!-- Page Header -->
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8 fade-in">
            <div>
                <h1 class="text-3xl font-bold text-secondary dark:text-white mb-1 font-display">Resource Allocation &
                    Emergency Response</h1>
                <p class="text-gray-600 dark:text-gray-400">Manage critical medical supplies, logistics, and emergency
                    dispatch requests</p>
            </div>

        </div>

        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 fade-in">
            <!-- Critical Requests -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl border-l-4 border-red-500 shadow-sm">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Critical Requests</p>
                        <h3 id="stat-critical" class="text-3xl font-bold text-gray-800 dark:text-white mt-1">--</h3>
                    </div>
                    <span class="p-2 bg-red-50 dark:bg-red-900/20 text-red-600 rounded-lg"><span
                            class="material-icons-outlined">priority_high</span></span>
                </div>
                <div class="text-xs text-red-500 font-semibold flex items-center gap-1">
                    <span class="material-icons-outlined text-xs">trending_up</span> +4 in last hour
                </div>
            </div>

            <!-- Active Dispatches -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl border-l-4 border-blue-500 shadow-sm">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Active Dispatches</p>
                        <h3 id="stat-active" class="text-3xl font-bold text-gray-800 dark:text-white mt-1">--</h3>
                    </div>
                    <span class="p-2 bg-blue-50 dark:bg-blue-900/20 text-blue-600 rounded-lg"><span
                            class="material-icons-outlined">local_shipping</span></span>
                </div>
                <div class="text-xs text-blue-500 font-semibold flex items-center gap-1">
                    <span class="material-icons-outlined text-xs">check_circle</span> 18 arriving today
                </div>
            </div>

            <!-- Pending Approvals -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl border-l-4 border-yellow-500 shadow-sm">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Pending Approvals</p>
                        <h3 id="stat-pending" class="text-3xl font-bold text-gray-800 dark:text-white mt-1">--</h3>
                    </div>
                    <span class="p-2 bg-yellow-50 dark:bg-yellow-900/20 text-yellow-600 rounded-lg"><span
                            class="material-icons-outlined">hourglass_empty</span></span>
                </div>
                <div class="text-xs text-gray-400 font-semibold">Avg wait: 45 mins</div>
            </div>

            <!-- Logicistics Efficiency -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl border-l-4 border-green-500 shadow-sm">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-gray-500 dark:text-gray-400 text-sm font-medium">Logistics Efficiency</p>
                        <h3 class="text-3xl font-bold text-gray-800 dark:text-white mt-1">94%</h3>
                    </div>
                    <span class="p-2 bg-green-50 dark:bg-green-900/20 text-green-600 rounded-lg"><span
                            class="material-icons-outlined">speed</span></span>
                </div>
                <div class="text-xs text-green-500 font-semibold flex items-center gap-1">
                    <span class="material-icons-outlined text-xs">arrow_upward</span> +2.5% this week
                </div>
            </div>
        </div>

        <!-- Main Content Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in">

            <!-- Left Column: Resource Requests (2/3 width) -->
            <div class="lg:col-span-2 space-y-8">

                <!-- Request Table Section -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm">
                    <div
                        class="p-6 border-b border-gray-100 dark:border-gray-700 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <h3 class="font-bold text-lg text-secondary dark:text-white flex items-center gap-2">
                            <span class="material-icons-outlined text-secondary dark:text-primary">assignment</span>
                            Recent Resource Requests
                        </h3>
                        <div class="flex gap-2">
                            <div class="relative">
                                <span
                                    class="material-icons-outlined absolute left-2 top-1.5 text-gray-400 text-sm">filter_list</span>
                                <select
                                    class="pl-8 pr-4 py-1.5 text-xs bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
                                    <option>All Priorities</option>
                                    <option>Critical</option>
                                    <option>High</option>
                                    <option>Normal</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[400px] overflow-y-auto custom-scrollbar">
                        <table class="w-full text-left border-collapse">
                            <thead
                                class="bg-gray-50 dark:bg-gray-900/50 text-xs uppercase text-gray-500 dark:text-gray-400 font-semibold">
                                <tr>
                                    <th class="px-6 py-4">Hospital ID / Name</th>
                                    <th class="px-6 py-4">Resource</th>
                                    <th class="px-6 py-4">Qty</th>
                                    <th class="px-6 py-4">Priority</th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="request-table-body"
                                class="divide-y divide-gray-100 dark:divide-gray-700 text-sm">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Logistics Map Placeholder -->
                <!-- Live Logistics Map (Embedded) -->
                <!-- National Stock Summary (Moved from Right) -->
                <div class="bg-gradient-to-br from-secondary to-secondary-light text-white rounded-2xl p-6 shadow-lg">
                    <h3 class="font-bold text-lg mb-6 flex items-center gap-2">
                        <span class="material-icons-outlined text-gov-gold">inventory</span> National Stockpiles
                    </h3>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Oxygen -->
                        <div
                            class="bg-white/5 p-4 rounded-xl border border-white/10 hover:bg-white/10 transition-colors">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-gray-300">Oxygen Reserves</span>
                                <span class="font-bold text-green-300">85%</span>
                            </div>
                            <div class="w-full bg-white/10 rounded-full h-2">
                                <div class="bg-green-400 h-2 rounded-full" style="width: 85%"></div>
                            </div>
                        </div>

                        <!-- Remdesivir -->
                        <div
                            class="bg-white/5 p-4 rounded-xl border border-white/10 hover:bg-white/10 transition-colors">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-gray-300">Remdesivir</span>
                                <span class="font-bold text-yellow-300">42%</span>
                            </div>
                            <div class="w-full bg-white/10 rounded-full h-2">
                                <div class="bg-yellow-400 h-2 rounded-full" style="width: 42%"></div>
                            </div>
                            <p class="text-[10px] text-yellow-200 mt-2 flex items-center gap-1"><span
                                    class="material-icons-outlined text-[10px]">warning</span> Low stock in Western
                                Region</p>
                        </div>

                        <!-- PPE -->
                        <div
                            class="bg-white/5 p-4 rounded-xl border border-white/10 hover:bg-white/10 transition-colors">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-gray-300">PPE Kits</span>
                                <span class="font-bold text-blue-300">92%</span>
                            </div>
                            <div class="w-full bg-white/10 rounded-full h-2">
                                <div class="bg-blue-400 h-2 rounded-full" style="width: 92%"></div>
                            </div>
                        </div>

                        <!-- ICU Beds -->
                        <div
                            class="bg-white/5 p-4 rounded-xl border border-white/10 hover:bg-white/10 transition-colors">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-gray-300">ICU Beds (Vacant)</span>
                                <span class="font-bold text-red-300">12%</span>
                            </div>
                            <div class="w-full bg-white/10 rounded-full h-2">
                                <div class="bg-red-400 h-2 rounded-full" style="width: 12%"></div>
                            </div>
                            <p class="text-[10px] text-red-200 mt-2 flex items-center gap-1"><span
                                    class="material-icons-outlined text-[10px]">error_outline</span> Critical shortage
                                in Delhi NCR</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: National Stockpile & Quick Actions -->
            <div class="space-y-6">
                <!-- National Stock Summary -->
                <!-- Live Logistics Map (Embedded - Moved to Right) -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden shadow-sm h-[520px] relative group">
                    <!-- Map Header Overlay -->
                    <!-- Map Header Removed -->

                    <button onclick="openTracker()"
                        class="absolute top-4 right-4 z-[400] bg-white dark:bg-gray-800 p-2 rounded-lg shadow-md hover:scale-110 transition-transform tooltip border border-gray-200 dark:border-gray-700"
                        title="Full Screen View">
                        <span class="material-icons-outlined text-gray-700 dark:text-gray-200">fullscreen</span>
                    </button>

                    <div id="embedded-map" class="absolute inset-0 w-full h-full z-0"></div>

                    <!-- Legend -->
                    <div
                        class="absolute bottom-4 left-4 right-4 z-[400] bg-white/95 dark:bg-gray-900/95 backdrop-blur px-3 py-2 rounded-lg shadow-sm text-[10px] font-bold uppercase tracking-wide border border-gray-200 dark:border-gray-700 flex flex-wrap gap-2 text-gray-600 dark:text-gray-300 justify-center">
                        <div class="flex items-center gap-1.5"><span
                                class="w-2.5 h-2.5 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></span>
                            Normal</div>
                        <div class="flex items-center gap-1.5"><span
                                class="w-2.5 h-2.5 rounded-full bg-yellow-400 shadow-[0_0_8px_rgba(250,204,21,0.6)]"></span>
                            Pending</div>
                        <div class="flex items-center gap-1.5"><span
                                class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.6)] animate-pulse"></span>
                            Critical</div>
                    </div>
                </div>

                <!-- Request Details Panel (Updates on Map Click) -->
                <div id="request-details-panel"
                    class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700 shadow-sm transition-all duration-300 min-h-[250px] flex flex-col justify-center mt-6">
                    <!-- Placeholder State -->
                    <div id="details-placeholder" class="text-center py-4 text-gray-500">
                        <div class="animate-bounce mb-2 inline-block">
                            <span class="material-icons-outlined text-3xl text-gray-300">touch_app</span>
                        </div>
                        <h4 class="font-bold text-gray-400 text-sm">Interactive Map</h4>
                        <p class="text-xs mt-1">Select any location on the map to view request details.</p>
                    </div>

                    <!-- Active Content State (Hidden by default) -->
                    <div id="details-content" class="hidden space-y-4 w-full">
                        <h3
                            class="font-bold text-xs text-secondary dark:text-gray-400 uppercase tracking-widest mb-2 flex items-center gap-2 border-b border-gray-100 dark:border-gray-700 pb-2">
                            <span class="material-icons-outlined text-sm">info</span> Selected Request
                        </h3>

                        <div class="flex justify-between items-start">
                            <div>
                                <h2 id="detail-hospital"
                                    class="text-lg font-bold text-gray-900 dark:text-white leading-tight"></h2>
                                <p id="detail-id" class="text-xs text-gray-500 mt-1"></p>
                            </div>
                            <span id="detail-priority" class=""></span>
                        </div>

                        <div class="grid grid-cols-2 gap-y-4 gap-x-2 py-2">
                            <div>
                                <p class="text-[10px] text-gray-500 uppercase font-bold">Resource</p>
                                <p id="detail-resource" class="font-semibold text-gray-800 dark:text-gray-200 text-sm">
                                </p>
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-500 uppercase font-bold">Quantity</p>
                                <p id="detail-qty" class="font-semibold text-gray-800 dark:text-gray-200 text-sm"></p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-[10px] text-gray-500 uppercase font-bold">Current Status</p>
                                <p id="detail-status" class="font-semibold text-sm"></p>
                            </div>
                        </div>

                        <div class="flex gap-3 pt-2">
                            <button
                                class="flex-1 py-2 bg-secondary hover:bg-secondary-light text-white rounded-lg font-bold shadow-md transition-colors text-xs uppercase tracking-wide flex items-center justify-center gap-2">
                                <span class="material-icons-outlined text-sm">check_circle</span> Approve
                            </button>
                            <button
                                class="flex-1 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 text-gray-700 dark:text-gray-300 rounded-lg font-bold transition-colors text-xs uppercase tracking-wide flex items-center justify-center gap-2">
                                <span class="material-icons-outlined text-sm">call</span> Contact
                            </button>
                        </div>
                    </div>
                </div>


            </div>
        </div>

    </main>

    <!-- LOGISTICS TRACKER MODAL -->
    <div id="tracker-modal" class="modal">
        <div
            class="bg-white dark:bg-gray-800 w-[95%] h-[90%] rounded-2xl overflow-hidden flex flex-col shadow-2xl relative">
            <!-- Map Header -->
            <div class="bg-secondary text-white p-4 flex justify-between items-center z-10 shadow-md">
                <div class="flex items-center gap-4">
                    <span class="material-icons-outlined text-gov-gold text-3xl">local_shipping</span>
                    <div>
                        <h2 class="text-xl font-bold font-display">National Logistics Command</h2>
                        <p class="text-xs text-gray-300">Live Tracking: <span id="active-shipments-count"
                                class="font-bold text-green-400">18</span> Active Shipments</p>
                    </div>
                </div>
                <button onclick="closeTracker()"
                    class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-colors">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>

            <!-- Map Container -->
            <div id="map" class="flex-grow z-0"></div>

            <!-- Tracking Overlay Panel -->
            <div
                class="absolute bottom-6 left-6 z-[1000] w-80 bg-white/95 dark:bg-gray-900/95 backdrop-blur rounded-xl p-4 shadow-xl border border-gray-200 dark:border-gray-700">
                <h3 class="font-bold text-gray-800 dark:text-white mb-3 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Shipment Details
                </h3>
                <div id="shipment-info" class="space-y-3">
                    <p class="text-sm text-gray-500 italic">Select a vehicle on the map to view details.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ACTION FORM MODAL (New Request / Allocation) -->
    <div id="action-modal" class="modal">
        <div class="bg-white dark:bg-gray-800 w-full max-w-lg rounded-2xl p-6 m-4 shadow-2xl transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white" id="modal-title">Initiate Emergency Relief
                </h3>
                <button onclick="closeActionModal()" class="text-gray-400 hover:text-gray-600"><span
                        class="material-icons-outlined">close</span></button>
            </div>

            <form id="resource-form" onsubmit="handleFormSubmit(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Target Hospital /
                        Region</label>
                    <input type="text"
                        class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-secondary"
                        placeholder="Search hospital..." required>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Resource
                            Type</label>
                        <select
                            class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                            <option>Liquid Oxygen</option>
                            <option>Remdesivir</option>
                            <option>ICU Ventilators</option>
                            <option>PPE Kits</option>
                            <option>Vaccines</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Quantity</label>
                        <input type="number"
                            class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"
                            placeholder="Amount" required>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Priority
                        Level</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="priority" value="Normal" class="text-secondary" checked>
                            <span class="text-sm">Normal</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="priority" value="High" class="text-orange-500">
                            <span class="text-sm font-medium text-orange-600">High</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="priority" value="Critical" class="text-red-500">
                            <span class="text-sm font-bold text-red-600">Critical</span>
                        </label>
                    </div>
                </div>

                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" onclick="closeActionModal()"
                        class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-medium">Cancel</button>
                    <button type="submit"
                        class="px-6 py-2 bg-secondary hover:bg-secondary-light text-white rounded-lg font-bold shadow-lg flex items-center gap-2">
                        <span class="material-icons-outlined">send</span> Dispatch
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- JavaScript -->
    <script src="../js/config/constants.js"></script>
    <script src="../js/config/app-config.js"></script>
    <script src="../js/utils/app-utils.js"></script>
    <script src="../js/utils/force-login.js"></script>
    <script src="../js/services/auth.js"></script>

    <script>
        // Use Global Helper for Map to persist instance if needed, or simple global var
        let mapInstance = null; // Fullscreen Map
        let embeddedMapInstance = null; // Embedded Map

        // Unified Data Source: Resource Requests (Table + Map)
        const resourceRequests = [
            // Critical Items
            { id: 'HOSP-DL-001', hospital: 'AIIMS Delhi', lat: 28.6139, lng: 77.2090, resource: 'Liquid Oxygen', qty: '15,000 L', priority: 'Critical', status: 'Pending Review' },
            { id: 'HOSP-UP-088', hospital: 'KGMU Lucknow', lat: 26.8467, lng: 80.9462, resource: 'Oxygen Tanker', qty: '8,000 L', priority: 'Critical', status: 'Pending Review' },
            { id: 'HOSP-UP-102', hospital: 'IMS BHU Varanasi', lat: 25.3176, lng: 82.9739, resource: 'Ventilators', qty: '50 Units', priority: 'Critical', status: 'Pending Review' },
            { id: 'HOSP-WB-045', hospital: 'Kolkata Med. College', lat: 22.5726, lng: 88.3639, resource: 'Remdesivir', qty: '200 Vials', priority: 'Critical', status: 'Pending Review' },
            { id: 'HOSP-MP-012', hospital: 'Bhopal Memorial', lat: 23.2599, lng: 77.4126, resource: 'ICU Beds', qty: '15 Beds', priority: 'Critical', status: 'Pending Review' },

            // Pending/High Priority Items
            { id: 'HOSP-MH-023', hospital: 'KEM Mumbai', lat: 19.0760, lng: 72.8777, resource: 'Remdesivir', qty: '500 Vials', priority: 'High', status: 'In Transit' },
            { id: 'HOSP-MH-099', hospital: 'Sasoon Pune', lat: 18.5204, lng: 73.8567, resource: 'Plasma Kit', qty: '20 Kits', priority: 'High', status: 'Pending - Logistics' },
            { id: 'HOSP-TG-055', hospital: 'Osmania Hyd', lat: 17.3850, lng: 78.4867, resource: 'N95 Masks', qty: '5000 Pcs', priority: 'High', status: 'Pending - Logistics' },
            { id: 'HOSP-GJ-067', hospital: 'Surat Civil', lat: 21.1702, lng: 72.8311, resource: 'Oxygen Cylinders', qty: '200 Units', priority: 'High', status: 'Pending Review' },

            // Normal/Fulfilled Items
            { id: 'HOSP-KA-012', hospital: 'Victoria Blr', lat: 12.9716, lng: 77.5946, resource: 'ICU Ventilators', qty: '10 Units', priority: 'Normal', status: 'Fulfilled' },
            { id: 'HOSP-TN-034', hospital: 'Apollo Chennai', lat: 13.0827, lng: 80.2707, resource: 'PPE Kits', qty: '2000 Units', priority: 'Normal', status: 'Fulfilled' },
            { id: 'HOSP-GJ-001', hospital: 'Civil Hosp Ahmedabad', lat: 23.0225, lng: 72.5714, resource: 'ICU Monitors', qty: '25 Units', priority: 'Normal', status: 'Dispatched' },
            { id: 'HOSP-CH-005', hospital: 'PGIMER Chandigarh', lat: 30.7333, lng: 76.7794, resource: 'Vaccines', qty: '10k Doses', priority: 'Normal', status: 'Dispatched' },
            { id: 'HOSP-RJ-089', hospital: 'SMS Jaipur', lat: 26.9124, lng: 75.7873, resource: 'Surgical Masks', qty: '10k Pcs', priority: 'Normal', status: 'Fulfilled' },
            { id: 'HOSP-GA-002', hospital: 'Goa Med College', lat: 15.2993, lng: 74.1240, resource: 'Sanitizers', qty: '500 L', priority: 'Normal', status: 'Fulfilled' },
            { id: 'HOSP-TN-101', hospital: 'Coimbatore Med', lat: 11.0168, lng: 76.9558, resource: 'Gloves', qty: '5000 Pairs', priority: 'Normal', status: 'Fulfilled' }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize auth service
            if (typeof AuthService !== 'undefined') {
                AuthService.init();
                const user = AuthService.getCurrentUser();
                if (!AuthService.isAuthenticated()) {
                    window.location.href = '../index.html';
                    return;
                }
                const adminName = document.getElementById('admin-name');
                const adminDept = document.getElementById('admin-dept');
                if (user) {
                    adminName.textContent = user.name || 'Ministry Admin';
                    if (user.department) adminDept.textContent = user.department;
                }
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', async () => {
                        await AuthService.logout();
                        window.location.href = '../index.html';
                    });
                }
            }

            // --- SETUP BUTTONS ---





            // 5. Live Tracker (Card) - No longer needed as it's an embedded map now
            // const cardTracker = document.getElementById('card-live-tracker');
            // if (cardTracker) {
            //     cardTracker.addEventListener('click', () => openTracker());
            // }

            // 6. Table Actions (Approve, Track, Details) - Event Delegation
            const tableBody = document.getElementById('request-table-body');
            if (tableBody) {
                tableBody.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if (!btn) return;

                    const row = btn.closest('tr');
                    const hospName = row.querySelector('.font-bold').textContent;

                    if (btn.classList.contains('btn-approve')) {
                        // Approve Action
                        const statusCell = row.querySelectorAll('td')[4];
                        statusCell.innerHTML = `
                            <span class="flex items-center gap-1 text-green-600 dark:text-green-400 font-medium text-xs">
                                <span class="w-2 h-2 rounded-full bg-green-500"></span> Approved
                            </span>
                        `;
                        btn.textContent = 'Approved';
                        btn.classList.replace('text-primary', 'text-gray-400');
                        btn.disabled = true;
                        showToast(`Request from ${hospName} Approved`, 'success');

                    } else if (btn.classList.contains('btn-track')) {
                        // Track Action
                        openTracker(hospName);

                    } else if (btn.classList.contains('btn-details')) {
                        // Details Action
                        showToast(`Showing details for ${hospName}`, 'info');
                    }
                });
            }

            // Initialize Page Content
            // Initialize Page Content
            populateTable();
            updateDashboardStats();
            initEmbeddedMap();
        });

        // --- POPULATE TABLE ---
        function populateTable() {
            const tbody = document.getElementById('request-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';

            resourceRequests.forEach(req => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700/30 transition-colors group';

                // Helper to determine styles based on priority/status
                let priorityClass = 'bg-gray-100 text-gray-700';
                if (req.priority === 'Critical') priorityClass = 'bg-red-100 text-red-700 border border-red-200 animate-pulse';
                else if (req.priority === 'High') priorityClass = 'bg-orange-100 text-orange-700 border border-orange-200';
                else if (req.priority === 'Normal') priorityClass = 'bg-green-100 text-green-700 border border-green-200';

                let statusColor = 'text-gray-600';
                let statusDot = 'bg-gray-500';
                if (req.status.includes('Pending')) { statusColor = 'text-yellow-600'; statusDot = 'bg-yellow-500'; }
                else if (req.status === 'Fulfilled' || req.status === 'Approved') { statusColor = 'text-green-600'; statusDot = 'bg-green-500'; }
                else if (req.status === 'In Transit' || req.status === 'Dispatched') { statusColor = 'text-blue-600'; statusDot = 'bg-blue-500'; }

                let actionBtn = `<button class="btn-approve text-primary hover:text-green-400 font-bold text-xs uppercase tracking-wide">Approve</button>`;
                if (req.status === 'In Transit' || req.status === 'Dispatched') actionBtn = `<button class="btn-track text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 font-bold text-xs uppercase tracking-wide">Track</button>`;
                else if (req.status === 'Fulfilled') actionBtn = `<button class="btn-details text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 font-bold text-xs uppercase tracking-wide">Details</button>`;

                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="font-bold text-gray-900 dark:text-white">${req.hospital}</div>
                        <div class="text-xs text-gray-500">${req.id}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                             <span class="w-8 h-8 rounded-full bg-blue-50 dark:bg-blue-900/20 text-blue-600 flex items-center justify-center material-icons-outlined text-sm">inventory_2</span>
                            <span>${req.resource}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 font-mono">${req.qty}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-xs font-bold ${priorityClass}">${req.priority.toUpperCase()}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="flex items-center gap-1 ${statusColor} dark:${statusColor.replace('600', '400')} font-medium text-xs">
                            <span class="w-2 h-2 rounded-full ${statusDot}"></span> ${req.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        ${actionBtn}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- MARKER LOGIC ---
        function createCustomIcon(priority) {
            let color = '#22c55e'; // green (Normal)
            let shadowColor = 'rgba(34,197,94,0.5)';
            let animationClass = '';

            if (priority === 'Critical') {
                color = '#ef4444'; // red
                shadowColor = 'rgba(239,68,68,0.5)';
                animationClass = 'animate-ping';
            } else if (priority === 'High' || priority === 'Pending') {
                color = '#facc15'; // yellow
                shadowColor = 'rgba(250,204,21,0.5)';
            }

            return L.divIcon({
                className: 'custom-dot-marker',
                html: `<div class="relative w-4 h-4 group cursor-pointer hover:scale-125 transition-transform">
                         <div class="absolute inset-0 rounded-full ${animationClass}" style="background-color: ${color}; opacity: 0.6;"></div>
                         <div class="absolute inset-0.5 rounded-full" style="background-color: ${color}; box-shadow: 0 0 10px ${shadowColor}; border: 1.5px solid white;"></div>
                       </div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
        }

        function updateDashboardStats() {
            if (!document.getElementById('stat-critical')) return;

            const criticalCount = resourceRequests.filter(r => r.priority === 'Critical').length;
            // Active = In Transit or Dispatched
            const activeCount = resourceRequests.filter(r => ['In Transit', 'Dispatched'].includes(r.status)).length;
            // Pending = Status contains Pending
            const pendingCount = resourceRequests.filter(r => r.status.includes('Pending')).length;

            document.getElementById('stat-critical').textContent = criticalCount;
            document.getElementById('stat-active').textContent = activeCount;
            document.getElementById('stat-pending').textContent = pendingCount;
        }

        function populateMap(targetMap) {
            resourceRequests.forEach(req => {
                // Determine color for popup badge
                let badgeClass = 'bg-blue-100 text-blue-600';
                if (req.priority === 'Critical') badgeClass = 'bg-red-100 text-red-600';
                else if (req.priority === 'High') badgeClass = 'bg-yellow-100 text-yellow-600';

                const marker = L.marker([req.lat, req.lng], { icon: createCustomIcon(req.priority) }).addTo(targetMap);

                // Add click listener to update the details panel for Embedded Map interactions
                marker.on('click', () => {
                    const detailsPanel = document.getElementById('request-details-panel');
                    const placeholder = document.getElementById('details-placeholder');
                    const content = document.getElementById('details-content');

                    if (detailsPanel && placeholder && content) {
                        placeholder.classList.add('hidden');
                        content.classList.remove('hidden');

                        // Update Content
                        document.getElementById('detail-hospital').textContent = req.hospital;
                        document.getElementById('detail-id').textContent = req.id;
                        document.getElementById('detail-resource').textContent = req.resource;
                        document.getElementById('detail-qty').textContent = req.qty;

                        const statusEl = document.getElementById('detail-status');
                        statusEl.textContent = req.status;
                        statusEl.className = 'font-semibold ' + (req.status.includes('Pending') ? 'text-yellow-600' : 'text-green-600');

                        const priorityEl = document.getElementById('detail-priority');
                        priorityEl.textContent = req.priority.toUpperCase();
                        priorityEl.className = 'px-2 py-1 rounded text-xs font-bold ' +
                            (req.priority === 'Critical' ? 'bg-red-100 text-red-600 animate-pulse' :
                                req.priority === 'High' ? 'bg-yellow-100 text-yellow-600' : 'bg-blue-100 text-blue-600');
                    }
                });

                const popupContent = `
                    <div class="text-left">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-[10px] font-bold uppercase tracking-wider text-gray-500">${req.priority}</span>
                            <span class="text-xs text-blue-600 font-bold">${req.status}</span>
                        </div>
                        <h3 class="font-bold text-sm text-gray-900 leading-tight mb-1">${req.hospital}</h3>
                        <p class="text-xs text-gray-500">${req.resource} â€¢ ${req.qty}</p>
                        <div class="mt-2 pt-2 border-t border-gray-100 flex gap-2">
                            <button class="flex-1 py-1 text-[10px] bg-secondary text-white rounded hover:bg-secondary-light transition-colors">Details</button>
                            <button class="flex-1 py-1 text-[10px] bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors">Contact</button>
                        </div>
                    </div>
                `;
                marker.bindPopup(popupContent, { minWidth: 200, className: 'custom-popup' });

                // Add click event for sidebar info (only for the main modal map)
                if (targetMap === mapInstance) {
                    marker.on('click', () => {
                        const infoPanel = document.getElementById('shipment-info');
                        if (infoPanel) {
                            infoPanel.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div><p class="text-gray-500 text-xs">Driver</p><p class="font-medium dark:text-gray-200">Rishabh K.</p></div>
                                    <div><p class="text-gray-500 text-xs">ETA</p><p class="font-medium dark:text-gray-200">2h 15m</p></div>
                                </div>
                            `;
                        }
                    });
                }
            });
        }

        // --- MAP FUNCTIONS ---

        function initEmbeddedMap() {
            if (document.getElementById('embedded-map')) {
                // Initialize map with a clean, dark style for the dashboard widget
                embeddedMapInstance = L.map('embedded-map', {
                    zoomControl: false,
                    attributionControl: false,
                    scrollWheelZoom: false,
                    dragging: false,
                    touchZoom: false,
                    doubleClickZoom: false
                }).setView([20.5937, 78.9629], 4);

                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    maxZoom: 19
                }).addTo(embeddedMapInstance);

                populateMap(embeddedMapInstance);
            }
        }

        function openTracker(focusTarget = null) {
            const modal = document.getElementById('tracker-modal');
            modal.classList.add('active');

            // Initialize Fullscreen Map on first open
            if (!mapInstance) {
                mapInstance = L.map('map').setView([20.5937, 78.9629], 5);

                // Dark Matter Tiles
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap &copy; CARTO',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(mapInstance);

                populateMap(mapInstance);
            }

            // Resize map (Important for modals!)
            setTimeout(() => { mapInstance.invalidateSize(); }, 100);

            if (focusTarget) {
                showToast(`Tracking delivery for ${focusTarget}`, 'info');
                // Logic to zoom to specific target would go here
            }
        }

        window.closeTracker = function () {
            document.getElementById('tracker-modal').classList.remove('active');
        }

        // --- ACTION MODAL FUNCTIONS ---

        window.openActionModal = function (title) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('action-modal').classList.add('active');
        }

        window.closeActionModal = function () {
            document.getElementById('action-modal').classList.remove('active');
        }

        window.handleFormSubmit = function (e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<span class="material-icons-outlined animate-spin">refresh</span> Dispatching...';
            btn.disabled = true;

            setTimeout(() => {
                closeActionModal();
                showToast('Resource Allocation Order Dispatched Successfully!', 'success');
                btn.innerHTML = originalText;
                btn.disabled = false;
                e.target.reset();
            }, 1000);
        }

        // Helper Toast Function (if Helpers is not available, though it should be)
        function showToast(message, type = 'info') {
            if (typeof Helpers !== 'undefined' && Helpers.showToast) {
                Helpers.showToast(message, type);
            } else {
                alert(message);
            }
        }
    </script>
</body>

</html>
