<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <link rel="icon" type="image/png" href="../assets/icons/favicon.png" />
    <title>Hospital Connectivity - Government Portal</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,container-queries"></script>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:wght@600;700&display=swap"
        rel="stylesheet" />

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />

    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#86efac",
                        secondary: "#113841",
                        "secondary-light": "#1d525e",
                        "background-dark": "#0d2b32",
                        "gov-gold": "#ffd700",
                    },
                    fontFamily: {
                        display: ["Playfair Display", "serif"],
                        sans: ["DM Sans", "sans-serif"],
                    },
                },
            },
        };
    </script>

    <style>
        .nav-link {
            transition: all 0.2s;
            position: relative;
        }

        .nav-link:hover {
            color: #86efac;
        }

        .nav-link.active {
            color: #86efac;
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: #86efac;
        }

        .hero-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%2386efac' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4v-4H4v4H0v2h4v4h2v-4h4v-2H6zM36 4v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .status-badge {
            animation: pulse-soft 2s ease-in-out infinite;
        }

        @keyframes pulse-soft {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .state-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .state-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            margin: auto;
            padding: 0;
            width: 95%;
            max-width: 1400px;
            max-height: 90vh;
            border-radius: 16px;
            overflow: hidden;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #113841;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-background-dark font-sans antialiased">

    <!-- Top Navigation -->
    <nav class="bg-secondary dark:bg-secondary text-white border-b border-white/10">
        <!-- Top Bar -->
        <div class="px-8 py-4 flex items-center justify-between border-b border-white/10">
            <a href="../index.html" class="flex items-center gap-3">
                <img src="../assets/images/logo.png" alt="SwasthyaSetu Logo" class="h-8 w-auto">
                <div class="flex flex-col">
                    <span class="text-xs font-bold text-gov-gold tracking-widest uppercase">MoHFW Interop Portal</span>
                    <span class="text-xs text-primary font-bold">GOVERNMENT</span>
                </div>
            </a>

            <div class="flex items-center gap-4">
                <div class="relative hidden lg:block">
                    <input type="text" id="search-input" placeholder="Search state or hospital..."
                        class="w-80 pl-10 pr-4 py-2 bg-secondary-light border border-white/20 rounded-lg text-sm text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <span class="material-icons-outlined absolute left-3 top-2.5 text-gray-400 text-sm">search</span>
                </div>
                <div class="flex items-center gap-3 ml-4 pl-4 border-l border-white/20">
                    <img src="https://ui-avatars.com/api/?name=Gov+Admin&background=ffd700&color=113841" alt="User"
                        class="w-8 h-8 rounded-full border border-gov-gold">
                    <div>
                        <p class="text-sm font-semibold" id="admin-name">Ministry Admin</p>
                        <p class="text-xs text-gov-gold" id="admin-dept">National Health Authority</p>
                    </div>
                </div>
                <button id="logout-btn"
                    class="ml-4 px-4 py-2 bg-red-500/80 hover:bg-red-600 text-white rounded-lg text-sm font-semibold transition-colors">
                    Logout
                </button>
            </div>
        </div>

        <!-- Navigation Links -->
        <div class="px-8 py-0 flex items-center gap-8">
            <a href="government-dashboard.html"
                class="nav-link flex items-center gap-2 px-4 py-4 text-sm font-medium text-gray-300">
                <span class="material-icons-outlined text-lg">insights</span>
                National Dashboard
            </a>
            <a href="government-hospitals.html"
                class="nav-link active flex items-center gap-2 px-4 py-4 text-sm font-medium">
                <span class="material-icons-outlined text-lg">domain</span>
                Hospital Connectivity
            </a>
            <a href="government-logs.html"
                class="nav-link flex items-center gap-2 px-4 py-4 text-sm font-medium text-gray-300">
                <span class="material-icons-outlined text-lg">sync_alt</span>
                Data Exchange Logs
            </a>
            <a href="government-compliance.html"
                class="nav-link flex items-center gap-2 px-4 py-4 text-sm font-medium text-gray-300">
                <span class="material-icons-outlined text-lg">policy</span>
                Compliance Monitor
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="p-8 hero-pattern min-h-screen">

        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-secondary dark:text-white mb-1 font-display">Hospital Connectivity -
                State-wise View</h1>
            <p class="text-gray-600 dark:text-gray-400">Monitor real-time connectivity across all states and union
                territories</p>
        </div>

        <!-- Overall Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <span class="material-icons-outlined text-4xl text-green-500">check_circle</span>
                    <span
                        class="px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-full text-xs font-bold">ACTIVE</span>
                </div>
                <h3 class="text-3xl font-bold text-secondary dark:text-white mb-1" id="total-connected">-</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">Connected Hospitals</p>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <span class="material-icons-outlined text-4xl text-yellow-500">warning</span>
                    <span
                        class="px-3 py-1 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300 rounded-full text-xs font-bold">PENDING</span>
                </div>
                <h3 class="text-3xl font-bold text-secondary dark:text-white mb-1" id="total-pending">-</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">Integration Pending</p>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <span class="material-icons-outlined text-4xl text-red-500">error</span>
                    <span
                        class="px-3 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-full text-xs font-bold">OFFLINE</span>
                </div>
                <h3 class="text-3xl font-bold text-secondary dark:text-white mb-1" id="total-offline">-</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">Connection Issues</p>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <span class="material-icons-outlined text-4xl text-blue-500">location_on</span>
                    <span
                        class="px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full text-xs font-bold">STATES</span>
                </div>
                <h3 class="text-3xl font-bold text-secondary dark:text-white mb-1" id="total-states">36</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">States & UTs</p>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="flex items-center justify-center py-20">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600 dark:text-gray-400">Loading hospital connectivity data...</p>
            </div>
        </div>

        <!-- States Grid -->
        <div id="states-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
            style="display: none;">
            <!-- State cards will be dynamically inserted here -->
        </div>

    </main>

    <!-- State Detail Modal -->
    <div id="state-modal" class="modal">
        <div class="modal-content dark:bg-gray-800">
            <div class="bg-secondary text-white p-6 flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold font-display" id="modal-state-name">-</h2>
                    <p class="text-sm text-primary mt-1" id="modal-hospital-count">-</p>
                </div>
                <button onclick="closeModal()" class="text-white hover:text-primary transition-colors">
                    <span class="material-icons-outlined text-3xl">close</span>
                </button>
            </div>

            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 100px);">
                <!-- Hospital Table -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700">
                            <tr>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider">
                                    Hospital</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider">
                                    Location</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider">
                                    Type</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider">
                                    Status</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider">
                                    Last Sync</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider">
                                    Uptime</th>
                            </tr>
                        </thead>
                        <tbody id="modal-hospital-list" class="divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Hospital rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../js/config/app-config.js"></script>
    <script src="../js/utils/helpers.js"></script>
    <script src="../js/utils/force-login.js"></script>
    <script src="../js/services/auth.js"></script>
    <script src="../js/services/api.js"></script>

    <script>
        // State-wise hospital connectivity management
        let allHospitals = [];
        let stateData = {};

        // Indian States and UTs
        const indianStates = [
            'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh',
            'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jharkhand',
            'Karnataka', 'Kerala', 'Madhya Pradesh', 'Maharashtra', 'Manipur',
            'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Punjab',
            'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura',
            'Uttar Pradesh', 'Uttarakhand', 'West Bengal',
            'Andaman and Nicobar Islands', 'Chandigarh', 'Dadra and Nagar Haveli and Daman and Diu',
            'Delhi', 'Jammu and Kashmir', 'Ladakh', 'Lakshadweep', 'Puducherry'
        ];

        // Generate random connection status
        function generateRandomStatus() {
            const statuses = ['Connected', 'Pending', 'Offline'];
            const weights = [0.85, 0.10, 0.05]; // 85% connected, 10% pending, 5% offline

            const random = Math.random();
            let sum = 0;
            for (let i = 0; i < weights.length; i++) {
                sum += weights[i];
                if (random <= sum) return statuses[i];
            }
            return 'Connected';
        }

        // Generate random uptime
        function generateRandomUptime(status) {
            if (status === 'Connected') return (95 + Math.random() * 5).toFixed(1);
            if (status === 'Pending') return (85 + Math.random() * 10).toFixed(1);
            return (75 + Math.random() * 15).toFixed(1);
        }

        // Generate random last sync time
        function generateRandomLastSync(status) {
            if (status === 'Connected') {
                const minutes = Math.floor(Math.random() * 30);
                return minutes === 0 ? 'Just now' : `${minutes} min${minutes > 1 ? 's' : ''} ago`;
            }
            if (status === 'Pending') {
                const hours = Math.floor(Math.random() * 12) + 1;
                return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            }
            const days = Math.floor(Math.random() * 5) + 1;
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }

        // Process hospitals and assign to states
        function processHospitalData(hospitals) {
            allHospitals = hospitals.map(hospital => ({
                ...hospital,
                status: generateRandomStatus(),
                uptime: null,
                lastSync: null
            }));

            // Assign uptime and last sync based on status
            allHospitals.forEach(h => {
                h.uptime = generateRandomUptime(h.status);
                h.lastSync = generateRandomLastSync(h.status);
            });

            // Group by state
            stateData = {};
            indianStates.forEach(state => {
                stateData[state] = {
                    connected: 0,
                    pending: 0,
                    offline: 0,
                    total: 0,
                    hospitals: []
                };
            });

            allHospitals.forEach(hospital => {
                const state = hospital.state || 'Delhi';
                if (stateData[state]) {
                    stateData[state].hospitals.push(hospital);
                    stateData[state].total++;

                    if (hospital.status === 'Connected') stateData[state].connected++;
                    else if (hospital.status === 'Pending') stateData[state].pending++;
                    else if (hospital.status === 'Offline') stateData[state].offline++;
                }
            });

            return stateData;
        }

        // Render state cards
        function renderStateCards() {
            const grid = document.getElementById('states-grid');
            grid.innerHTML = '';

            Object.entries(stateData).forEach(([state, data]) => {
                if (data.total === 0) return; // Skip states with no hospitals

                const connectivityRate = data.total > 0 ? ((data.connected / data.total) * 100).toFixed(1) : 0;

                const card = document.createElement('div');
                card.className = 'state-card bg-white dark:bg-gray-800 rounded-2xl p-6 border border-gray-200 dark:border-gray-700';
                card.onclick = () => openStateModal(state, data);

                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-secondary dark:text-white">${state}</h3>
                            <p class="text-xs text-gray-500 mt-1">${data.total} hospital${data.total !== 1 ? 's' : ''}</p>
                        </div>
                        <div class="w-12 h-12 bg-secondary/10 rounded-lg flex items-center justify-center">
                            <span class="material-icons-outlined text-secondary">location_on</span>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex items-center justify-between text-xs mb-2">
                            <span class="font-semibold text-gray-700 dark:text-gray-300">Connectivity</span>
                            <span class="font-bold ${connectivityRate >= 90 ? 'text-green-600' : connectivityRate >= 70 ? 'text-yellow-600' : 'text-red-600'}">${connectivityRate}%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="h-2 rounded-full ${connectivityRate >= 90 ? 'bg-green-500' : connectivityRate >= 70 ? 'bg-yellow-500' : 'bg-red-500'}" style="width: ${connectivityRate}%"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-2">
                            <p class="text-lg font-bold text-green-600">${data.connected}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Online</p>
                        </div>
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-2">
                            <p class="text-lg font-bold text-yellow-600">${data.pending}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Pending</p>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-2">
                            <p class="text-lg font-bold text-red-600">${data.offline}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Offline</p>
                        </div>
                    </div>
                `;

                grid.appendChild(card);
            });

            // Update overall stats
            const totalConnected = Object.values(stateData).reduce((sum, s) => sum + s.connected, 0);
            const totalPending = Object.values(stateData).reduce((sum, s) => sum + s.pending, 0);
            const totalOffline = Object.values(stateData).reduce((sum, s) => sum + s.offline, 0);

            document.getElementById('total-connected').textContent = totalConnected.toLocaleString();
            document.getElementById('total-pending').textContent = totalPending.toLocaleString();
            document.getElementById('total-offline').textContent = totalOffline.toLocaleString();
        }

        // Open state modal
        function openStateModal(stateName, data) {
            document.getElementById('modal-state-name').textContent = stateName;
            document.getElementById('modal-hospital-count').textContent = `${data.total} Registered Hospitals`;

            const tbody = document.getElementById('modal-hospital-list');
            tbody.innerHTML = '';

            data.hospitals.forEach(hospital => {
                const statusColors = {
                    'Connected': 'green',
                    'Pending': 'yellow',
                    'Offline': 'red'
                };
                const color = statusColors[hospital.status] || 'gray';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-secondary/10 rounded-lg flex items-center justify-center">
                                <span class="material-icons-outlined text-secondary">local_hospital</span>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900 dark:text-white">${hospital.name}</p>
                                <p class="text-xs text-gray-500">ID: HOSP-${Math.floor(Math.random() * 9000) + 1000}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">${hospital.address || hospital.city || stateName}</td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-full text-xs font-semibold">
                            ${hospital.type || 'General'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 bg-${color}-500 rounded-full status-badge"></span>
                            <span class="text-sm font-semibold text-${color}-600 dark:text-${color}-400">${hospital.status}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">${hospital.lastSync}</td>
                    <td class="px-6 py-4 text-sm font-semibold text-gray-900 dark:text-white">${hospital.uptime}%</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('state-modal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('state-modal').classList.remove('active');
        }

        // Close modal on outside click
        window.onclick = function (event) {
            const modal = document.getElementById('state-modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize auth service
            AuthService.init();

            // Check authentication
            const user = AuthService.getCurrentUser();
            if (!AuthService.isAuthenticated()) {
                window.location.href = '../index.html';
                return;
            }

            // Fill user details
            const adminName = document.getElementById('admin-name');
            const adminDept = document.getElementById('admin-dept');

            if (user) {
                adminName.textContent = user.name || 'Ministry Admin';
                if (user.department) adminDept.textContent = user.department;
            }

            // Logout handler
            document.getElementById('logout-btn').addEventListener('click', async () => {
                await AuthService.logout();
                Helpers.showToast('Securely logged out', 'success');
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 1000);
            });

            // Fetch hospital data
            try {
                const response = await APIService.getHospitals();
                const hospitals = response.data || response || [];

                processHospitalData(hospitals);
                renderStateCards();

                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('states-grid').style.display = 'grid';
            } catch (error) {
                console.error('Error fetching hospitals:', error);
                document.getElementById('loading-state').innerHTML = `
                    <div class="text-center">
                        <span class="material-icons-outlined text-6xl text-red-500 mb-4">error</span>
                        <p class="text-gray-600 dark:text-gray-400 mb-2">Failed to load hospital data</p>
                        <p class="text-sm text-gray-500">${error.message}</p>
                        <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-secondary text-white rounded-lg hover:bg-secondary-light transition-colors">
                            Retry
                        </button>
                    </div>
                `;
            }

            // Search functionality
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const cards = document.querySelectorAll('.state-card');

                cards.forEach(card => {
                    const stateName = card.querySelector('h3').textContent.toLowerCase();
                    if (stateName.includes(query)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });
    </script>
</body>

</html>